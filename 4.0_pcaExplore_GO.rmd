---
title: "PCAExpl.rmd"
output: html_document
author: Tina Gorsek Sparovec
date: 10.2.21
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# using the package pcaExplorer and clusterprofiler
you need to use the data with the symbol and entrez
https://bioconductor.statistik.tu-dortmund.de/packages/3.6/bioc/vignettes/clusterProfiler/inst/doc/clusterProfiler.html#dotplot 

https://bioconductor.org/packages/devel/bioc/vignettes/pcaExplorer/inst/doc/pcaExplorer.html#9_Functions_exported_by_the_package_for_standalone_usage 
```{r}
library(DESeq2)
library(clusterProfiler)
library(airway)
data(airway)

dds_airway <- DESeqDataSet(airway,design= ~ cell + dex)
#dds_airway<-DESeqDataSetFromMatrix(countData = PAS,
 #                           colData=anno,
  #                          design = ~ sectio+ Csec+ Grav + Para+  GWscaled +place)
#adding an info about the ENS code

rld_airway <- rlogTransformation(dds_airway)
rld_airway
```
##On airway data 
```{r}
pcaExplorer(dds = dds_airway,
            dst = rld_airway)
library(org.Hs.eg.db)
keytypes(org.Hs.eg.db)

# didnt work with org.HS. trying with ENSsDb
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

#BiocManager::install("EnsDb.Hsapiens.v75")
#library(EnsDb.Hsapiens.v75)

dds_airway <- DESeq(dds_airway)
res_airway <- results(dds_airway) #this will be used from dds object from 1.0 metadata
genenames_airway <- mapIds(org.Hs.eg.db,keys = rownames(dds_airway),column = "SYMBOL",keytype="ENSEMBL")
annotation_airway <- data.frame(gene_name = genenames_airway,
                                row.names = rownames(dds_airway),
                                stringsAsFactors = FALSE)
head(annotation_airway)   
# the other
anno_df_orgdb <- get_annotation_orgdb(dds = dds_airway,
                                      orgdb_species = "org.Hs.eg.db",
                                      idtype = "ENSEMBL")

anno_df_biomart <- get_annotation(dds = dds_airway,
                                  biomart_dataset = "hsapiens_gene_ensembl",
                                  idtype = "ensembl_gene_id")
res_airway$symbol <- mapIds(org.Hs.eg.db,
                            keys= row.names(res_airway),
                            column="SYMBOL",
                            keytype="ENSEMBL",
                            multiVals="first")
res_airway$entrez <- mapIds(org.Hs.eg.db, ##problem 
                            keys=row.names(res_airway),
                            column="ENTREZID",
                            keytype="ENSEMBL",
                            multiVals="first")
resOrdered <- as.data.frame(res_airway[order(res_airway$padj),])
head(resOrdered)
# extract DE genes
de_df <- resOrdered[resOrdered$padj < .05 & !is.na(resOrdered$padj),]
de_symbols <- de_df$symbol
# extract background genes
bg_ids <- rownames(dds_airway)[rowSums(counts(dds_airway)) > 0]
bg_symbols <- mapIds(org.Hs.eg.db,
                     keys=bg_ids,
                     column="SYMBOL",
                     keytype="ENSEMBL",
                     multiVals="first")
# run the function
topgoDE_airway <- topGOtable(de_symbols, bg_symbols,
                             ontology = "BP",
                             mapping = "org.Hs.eg.db",
                             geneID = "symbol")
```
# on PAS data

https://bioconductor.org/packages/devel/bioc/vignettes/pcaExplorer/inst/doc/pcaExplorer.html#97_topGOtable 

```{r}
#using res, anno, PAS 
dds_GO <- DESeq(dds)
res<- results(dds_GO)
ENS_res<- merge(as.data.frame(res), PASbackup, by.y="gene_id", by.x= "row.names")
ENS_res$Row.names<-gsub("\\..*","",ENS_res$Row.names)
rownames(ENS_res)<-make.names(ENS_res$Row.names, unique=T) #renaming the rownames
#names(ENS_res)[names(ENS_res) == "Row.names"] <- "gene_id"

genenames_GO<-mapIds(org.Hs.eg.db,
                     keys=ENS_res$Row.names, 
                     column = "SYMBOL",
                     keytype = "ENSEMBL")
annotation_GO <- data.frame(gene_name = genenames_GO,  
                                row.names = row.names(ENS_res),
                                stringsAsFactors = FALSE)
head(annotation_GO)  

#anno_df is not needed- do not run
anno_df_orgdb <- get_annotation_orgdb(dds = dds_GO,
                                      orgdb_species = "org.Hs.eg.db",
                                      idtype = "ENSEMBL")

anno_df_biomart <- get_annotation(dds = dds_GO,
                                  biomart_dataset = "hsapiens_gene_ensembl",
                                  idtype = "ensembl_gene_id")

intersect(rownames(res), keys(org.Hs.eg.db,"ENSEMBL")) # not all keys are in the rownames


res$symbol<- mapIds(org.Hs.eg.db,
                            keys= row.names(ENS_res),
                            column="SYMBOL",
                            keytype="ENSEMBL",
                            multiVals="first")
res$entrez <- mapIds(org.Hs.eg.db, ##problem 
                            keys=row.names(ENS_res), #these keys are not correct
                            column="ENTREZID",
                            keytype="ENSEMBL",
                            multiVals="first")
resOrdered <- as.data.frame(res[order(res$padj),])
head(resOrdered)

de_df <- resOrdered[resOrdered$padj < .05 & !is.na(resOrdered$padj),]
de_symbols <- de_df$symbol
# extract background genes
bg_ids <- rownames(dds_GO)[rowSums(counts(dds_GO)) > 0]
bg_ids<-gsub("\\..*","",bg_ids)
bg_symbols <- mapIds(org.Hs.eg.db,
                     keys=bg_ids,
                     column="SYMBOL",
                     keytype="ENSEMBL",
                     multiVals="first")
# run the function
topgoDE_GO <- topGOtable(de_symbols, bg_symbols,
                             ontology = "BP",
                             mapping = "org.Hs.eg.db",
                             geneID = "symbol")
#error NA in rownames

```

